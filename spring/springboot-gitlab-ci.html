<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用gitlab CI 对Springboot项目进行容器化持续发布 | 油腻中年大叔</title>
    <meta name="description" content="你想要的这里都没有，你不想要的这里都有">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    
    <link rel="preload" href="/assets/css/styles.ded2f491.css" as="style"><link rel="preload" href="/assets/js/app.ded2f491.js" as="script"><link rel="preload" href="/assets/js/4.80c27a58.js" as="script"><link rel="prefetch" href="/assets/js/0.eb7108e7.js"><link rel="prefetch" href="/assets/js/1.d8ec4d72.js"><link rel="prefetch" href="/assets/js/2.28f90b8d.js"><link rel="prefetch" href="/assets/js/3.6001361f.js"><link rel="prefetch" href="/assets/js/5.2e2f809b.js"><link rel="prefetch" href="/assets/js/6.0d0d8441.js"><link rel="prefetch" href="/assets/js/7.8e4037c3.js"><link rel="prefetch" href="/assets/js/8.5752a787.js"><link rel="prefetch" href="/assets/js/9.8329deb8.js"><link rel="prefetch" href="/assets/js/10.4843c5ba.js"><link rel="prefetch" href="/assets/js/11.9e8b7549.js"><link rel="prefetch" href="/assets/js/12.02c0fa30.js"><link rel="prefetch" href="/assets/js/13.f5d738e8.js"><link rel="prefetch" href="/assets/js/14.24f8e576.js"><link rel="prefetch" href="/assets/js/15.e752518b.js"><link rel="prefetch" href="/assets/js/16.d74da356.js"><link rel="prefetch" href="/assets/js/17.5759e4d8.js"><link rel="prefetch" href="/assets/js/18.4e466a14.js"><link rel="prefetch" href="/assets/js/19.60a2d73f.js"><link rel="prefetch" href="/assets/js/20.c9a0e62d.js"><link rel="prefetch" href="/assets/js/21.40026d70.js"><link rel="prefetch" href="/assets/js/22.c5b0ef8a.js"><link rel="prefetch" href="/assets/js/23.6f254965.js"><link rel="prefetch" href="/assets/js/24.fcf66f98.js"><link rel="prefetch" href="/assets/js/25.76bed4da.js"><link rel="prefetch" href="/assets/js/26.a29ecb98.js"><link rel="prefetch" href="/assets/js/27.19c14279.js"><link rel="prefetch" href="/assets/js/28.da0a820a.js"><link rel="prefetch" href="/assets/js/29.ac0b92bb.js"><link rel="prefetch" href="/assets/js/30.2f36adb4.js"><link rel="prefetch" href="/assets/js/31.3b64636b.js"><link rel="prefetch" href="/assets/js/32.ab10440c.js"><link rel="prefetch" href="/assets/js/33.68e3f3f0.js"><link rel="prefetch" href="/assets/js/34.3996b8a2.js"><link rel="prefetch" href="/assets/js/35.6b7df171.js"><link rel="prefetch" href="/assets/js/36.01c663d5.js"><link rel="prefetch" href="/assets/js/37.24b862f7.js"><link rel="prefetch" href="/assets/js/38.27c698de.js"><link rel="prefetch" href="/assets/js/39.39eda98a.js"><link rel="prefetch" href="/assets/js/40.0d3a27e1.js"><link rel="prefetch" href="/assets/js/41.36133d84.js"><link rel="prefetch" href="/assets/js/42.4f708108.js"><link rel="prefetch" href="/assets/js/43.286ed069.js"><link rel="prefetch" href="/assets/js/44.69931ba8.js"><link rel="prefetch" href="/assets/js/45.9b6a53af.js"><link rel="prefetch" href="/assets/js/46.44e01f27.js"><link rel="prefetch" href="/assets/js/47.86ea0068.js"><link rel="prefetch" href="/assets/js/48.6d6e8398.js"><link rel="prefetch" href="/assets/js/49.eb3a0c16.js"><link rel="prefetch" href="/assets/js/50.5b9dbd38.js"><link rel="prefetch" href="/assets/js/51.e16cec94.js"><link rel="prefetch" href="/assets/js/52.08a38998.js"><link rel="prefetch" href="/assets/js/53.eab809f5.js"><link rel="prefetch" href="/assets/js/54.d13dbba6.js"><link rel="prefetch" href="/assets/js/55.6808ce92.js"><link rel="prefetch" href="/assets/js/56.096d270b.js"><link rel="prefetch" href="/assets/js/57.e4249cdf.js"><link rel="prefetch" href="/assets/js/58.c8669079.js"><link rel="prefetch" href="/assets/js/59.ad4f9d5d.js"><link rel="prefetch" href="/assets/js/60.1fb42366.js"><link rel="prefetch" href="/assets/js/61.cabe5660.js"><link rel="prefetch" href="/assets/js/62.fa1a1298.js"><link rel="prefetch" href="/assets/js/63.45ab79de.js"><link rel="prefetch" href="/assets/js/64.1b1f9f0e.js"><link rel="prefetch" href="/assets/js/65.8ec5686f.js"><link rel="prefetch" href="/assets/js/66.c678baef.js"><link rel="prefetch" href="/assets/js/67.19e5c964.js"><link rel="prefetch" href="/assets/js/68.1ed9f179.js"><link rel="prefetch" href="/assets/js/69.c24b07f2.js"><link rel="prefetch" href="/assets/js/70.0d51bff2.js"><link rel="prefetch" href="/assets/js/71.c4b4b293.js"><link rel="prefetch" href="/assets/js/72.14906a78.js"><link rel="prefetch" href="/assets/js/73.63ff0ad9.js"><link rel="prefetch" href="/assets/js/74.b9adca9b.js"><link rel="prefetch" href="/assets/js/75.545e5298.js"><link rel="prefetch" href="/assets/js/76.a0b47a49.js"><link rel="prefetch" href="/assets/js/77.7e27edab.js"><link rel="prefetch" href="/assets/js/78.1142e5fa.js"><link rel="prefetch" href="/assets/js/79.7c5cfce2.js"><link rel="prefetch" href="/assets/js/80.fc2c556d.js"><link rel="prefetch" href="/assets/js/81.8879b553.js"><link rel="prefetch" href="/assets/js/82.eacf1768.js"><link rel="prefetch" href="/assets/js/83.e45b0c21.js"><link rel="prefetch" href="/assets/js/84.1a4d1083.js"><link rel="prefetch" href="/assets/js/85.03758b26.js"><link rel="prefetch" href="/assets/js/86.ee483071.js"><link rel="prefetch" href="/assets/js/87.7b7f9f7e.js"><link rel="prefetch" href="/assets/js/88.ac9c1638.js"><link rel="prefetch" href="/assets/js/89.eb052447.js"><link rel="prefetch" href="/assets/js/90.422140a0.js"><link rel="prefetch" href="/assets/js/91.1590a6f8.js"><link rel="prefetch" href="/assets/js/92.96889e30.js"><link rel="prefetch" href="/assets/js/93.781dc372.js"><link rel="prefetch" href="/assets/js/94.67dfc4fd.js"><link rel="prefetch" href="/assets/js/95.2ec84126.js"><link rel="prefetch" href="/assets/js/96.9c8d4164.js"><link rel="prefetch" href="/assets/js/97.8e9b31ed.js"><link rel="prefetch" href="/assets/js/98.9842e1fc.js"><link rel="prefetch" href="/assets/js/99.393bed11.js"><link rel="prefetch" href="/assets/js/100.cce59a63.js"><link rel="prefetch" href="/assets/js/101.a716746b.js"><link rel="prefetch" href="/assets/js/102.8c93513c.js"><link rel="prefetch" href="/assets/js/103.d3a45484.js"><link rel="prefetch" href="/assets/js/104.ce471cd5.js"><link rel="prefetch" href="/assets/js/105.333da2a2.js"><link rel="prefetch" href="/assets/css/106.styles.2ca1612a.css"><link rel="prefetch" href="/assets/js/106.2ca1612a.js"><link rel="prefetch" href="/assets/css/107.styles.da40c964.css"><link rel="prefetch" href="/assets/js/107.da40c964.js">
    <link rel="stylesheet" href="/assets/css/106.styles.2ca1612a.css"><link rel="stylesheet" href="/assets/css/107.styles.da40c964.css"><link rel="stylesheet" href="/assets/css/styles.ded2f491.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">油腻中年大叔</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dart/" class="nav-link">Dart</a></div><div class="nav-item"><a href="/spring/" class="nav-link router-link-active">spring</a></div><div class="nav-item"><a href="/drools/" class="nav-link">规则和业务流程</a></div><div class="nav-item"><a href="/eip/" class="nav-link">EIP集成工具</a></div><div class="nav-item"><a href="/other/" class="nav-link">杂项</a></div><div class="nav-item"><a href="/algorithms/" class="nav-link">算法</a></div><div class="nav-item"><a href="/riding/" class="nav-link">骑行</a></div><div class="nav-item"><a href="/ev3/" class="nav-link">LEGO EV3 </a></div><div class="nav-item"><a href="/mb/" class="nav-link">Micro:bit </a></div><div class="nav-item"><a href="/math/" class="nav-link">小学数学 </a></div><div class="nav-item"><a href="/eng/" class="nav-link">小学英语 </a></div><div class="nav-item"><a href="/jp/" class="nav-link">日语 </a></div><div class="nav-item"><a href="/gs1/" class="nav-link">GS-1</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/spring/writetofile.html" class="sidebar-link">JavaIO-DataoutPut</a></li><li><a href="/spring/java-classloader.html" class="sidebar-link">java类加载器</a></li><li><a href="/spring/jvm-stack.html" class="sidebar-link">jvm 相关</a></li><li><a href="/spring/annotation.html" class="sidebar-link">注解的使用</a></li><li><a href="/spring/SpringAnnotations.html" class="sidebar-link">Spring注解速查</a></li><li><a href="/spring/springboot.html" class="sidebar-link">Springboot 配置速查</a></li><li><a href="/spring/springbootRun.html" class="sidebar-link">Springboot启动过程</a></li><li><a href="/spring/springboot-gitlab-ci.html" class="active sidebar-link">Springboot基于Gitlab持续集成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#创建一个springboot项目" class="sidebar-link">创建一个Springboot项目</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#给项目提供gitlab-ci功能" class="sidebar-link">给项目提供gitlab CI功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#项目容器编译脚本" class="sidebar-link">项目容器编译脚本</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#创建ci-pipeline-脚本" class="sidebar-link">创建CI pipeline 脚本</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#其他总结" class="sidebar-link">其他总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#gitlab-runner配置模式" class="sidebar-link">gitlab runner配置模式</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#config-toml里的concurrent字段的意义" class="sidebar-link">config.toml里的concurrent字段的意义</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#cache存储在哪里" class="sidebar-link">cache存储在哪里</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#怎样清除cache" class="sidebar-link">怎样清除cache</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#mac上的docker-volume在哪" class="sidebar-link">mac上的docker volume在哪</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#gitlab-ci详解" class="sidebar-link">Gitlab CI详解</a></li><li class="sidebar-sub-header"><a href="/spring/springboot-gitlab-ci.html#maven的settings-xml" class="sidebar-link">maven的settings.xml</a></li></ul></li></ul></li><li><a href="/spring/SpringBootTesting.html" class="sidebar-link">SpringBoot 测试</a></li><li><a href="/spring/TestingControllersInSpringboot.html" class="sidebar-link">SpringBoot的Contoller测试</a></li><li><a href="/spring/JacksonObjectMapperCheetSheet.html" class="sidebar-link">Jackson ObjectMapper CheetSheet</a></li><li><a href="/spring/lock.html" class="sidebar-link">占用bug分析</a></li><li><a href="/spring/singleton-scope.html" class="sidebar-link">Spring MVC 并发与线程安全</a></li><li><a href="/spring/singleton.html" class="sidebar-link">设计模式-单件</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="使用gitlab-ci-对springboot项目进行容器化持续发布"><a href="#使用gitlab-ci-对springboot项目进行容器化持续发布" aria-hidden="true" class="header-anchor">#</a> 使用gitlab CI 对Springboot项目进行容器化持续发布</h1> <h2 id="创建一个springboot项目"><a href="#创建一个springboot项目" aria-hidden="true" class="header-anchor">#</a> 创建一个Springboot项目</h2> <p>可以使用如下多种方式创建项目：</p> <ul><li>使用idea的Springboot插件</li> <li>Maven</li> <li>Springboot CLI</li></ul> <p>我们只需要创建一个空项目，不需要写太多的代码。为了验证，我们给项目提供actuator的功能。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>management.endpoint.beans.enabled=true
management.endpoint.info.enabled=true
management.endpoint.health.enabled=true
management.endpoints.web.exposure.include=health,info

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>项目创建完成后，启动项目测试一下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># curl http://localhost:8080/actuator/health

{&quot;status&quot;:&quot;UP&quot;}%

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="给项目提供gitlab-ci功能"><a href="#给项目提供gitlab-ci功能" aria-hidden="true" class="header-anchor">#</a> 给项目提供gitlab CI功能</h2> <h3 id="项目容器编译脚本"><a href="#项目容器编译脚本" aria-hidden="true" class="header-anchor">#</a> 项目容器编译脚本</h3> <div class="language-docker line-numbers-mode"><pre class="language-docker"><code><span class="token keyword">FROM</span> openjdk<span class="token punctuation">:</span>8u111<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span>alpine
<span class="token keyword">VOLUME</span> /tmp
<span class="token keyword">ADD</span> /target/springbootci<span class="token punctuation">-</span>0.0.1<span class="token punctuation">-</span>SNAPSHOT.jar app.jar
<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-jar&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/app.jar&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>springbootci-0.0.1-SNAPSHOT.jar</code>是项目pom文件声明的产物名称</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.freshal.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springbootci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>springbootci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="创建ci-pipeline-脚本"><a href="#创建ci-pipeline-脚本" aria-hidden="true" class="header-anchor">#</a> 创建CI pipeline 脚本</h3> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci

stages:
  - build
  - package

maven-build:
  image: maven:3-jdk-8A
  stage: build
  script: &quot;mvn package -B&quot;
  artifacts:
    paths:
      - target/*.jar

docker-build:
  stage: package
  script:
    - docker build -t freshal/springbootci .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="image-和service"><a href="#image-和service" aria-hidden="true" class="header-anchor">#</a> image 和service</h4> <p>GitLab Runner可以使用容器镜像来支持流水线。image元素定义了我们要使用哪个镜像。
有效的镜像仅限于本地容器引擎和Docker Hub存储的。
service元素定义了额外的要使用的链接到主容器的镜像。在我们的例子中，主要容器是一个普通容器镜像，而链接容器是一个容器中的容器（Docker in Docker）</p> <ul><li>关于dind的说明：https://docs.gitlab.com/ee/ci/docker/using_docker_build.html</li></ul> <h4 id="variables"><a href="#variables" aria-hidden="true" class="header-anchor">#</a> Variables</h4> <p>变量可以定义编译环境使用的参数。
具体参考：https://docs.gitlab.com/ee/ci/yaml/#variables</p> <p>GITALB已经预定义了一些变量，见：http://git.manystar.com/help/ci/variables/predefined_variables.md</p> <h4 id="stages"><a href="#stages" aria-hidden="true" class="header-anchor">#</a> Stages</h4> <p>stages元素定义了流水线的生命周期。我们给每一个stage都关联一个job。一个stage中的所有job并行运行，并按照我们定义的顺序依次触发各个stage，即，只有在上一个stage完成后才启动下一个stage。</p> <h4 id="maven-build-job"><a href="#maven-build-job" aria-hidden="true" class="header-anchor">#</a> maven build job</h4> <p>这个job是执行maven构建，所以使用了<code>maven:3-jdk-8</code>作为执行构建的容器镜像。</p> <p><code>script</code>是一个gitlab runner要执行的shell 命令。<code>The mvn package -B</code>启动一个非交互式的maven构建过程。mvn package包括validate,compile,和test。</p> <p>在不同的job之前持久化可执行的jar，我们声明job的产物。这些产物是每次成功构建后的输出文件，可以在gitlab流水线的界面上下载。
<img src="/assets/img/ci-artifacts.eb5e792a.jpg" alt="ci-artifacts.jpg"></p> <ul><li>maven 详细例子：https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Maven.gitlab-ci.yml</li> <li>gradle 详细例子：https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Gradle.gitlab-ci.yml</li></ul> <h4 id="容器创建"><a href="#容器创建" aria-hidden="true" class="header-anchor">#</a> 容器创建</h4> <p>关于容器创建的详细例子参考：https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Docker.gitlab-ci.yml</p> <h4 id="缓存maven库"><a href="#缓存maven库" aria-hidden="true" class="header-anchor">#</a> 缓存maven库</h4> <p>如果每次都新建容器，下载依赖，非常影响效率，为了解决这个问题，可以使用cache。</p> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>
image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci
  MAVEN_OPTS: &quot;-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository&quot;

cache:
  paths:
    - .m2/repository

stages:
  - build
  - package

maven-build:
  image: maven:3-jdk-8A
  stage: build
  script: &quot;mvn package -B&quot;
  artifacts:
    paths:
      - target/*.jar

docker-build:
  stage: package
  script:
    - docker build -t freshal/springbootci .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>关于cache的详细例子：
https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Maven.gitlab-ci.yml</p> <h2 id="其他总结"><a href="#其他总结" aria-hidden="true" class="header-anchor">#</a> 其他总结</h2> <h3 id="gitlab-runner配置模式"><a href="#gitlab-runner配置模式" aria-hidden="true" class="header-anchor">#</a> gitlab runner配置模式</h3> <p>gitlab runner有三种配置方式</p> <ul><li>shell执行</li> <li>Docker in Docker</li> <li>Docker socket bind
这三种模式没有一种更好，更多的需要权衡。dind模式会比较慢一些，因为每一个job都在一个干净的环境中，但是这允许并发且不会冲突。另外dind和socket bind模式不能混用。</li></ul> <h3 id="config-toml里的concurrent字段的意义"><a href="#config-toml里的concurrent字段的意义" aria-hidden="true" class="header-anchor">#</a> config.toml里的concurrent字段的意义</h3> <p>concurrent限制了整个GitLab Runner能并发处理job的数量。特别注意concurrent与worker数量无任何关系，所有worker的工作是受GitLab Runner控制的，如果concurrent值为1并且有一个worker已经在工作了，那么即使其他worker达到了可以工作的条件也只能“pending”。</p> <p>config.toml配置说明：
https://docs.gitlab.com/runner/configuration/advanced-configuration.html</p> <h3 id="cache存储在哪里"><a href="#cache存储在哪里" aria-hidden="true" class="header-anchor">#</a> cache存储在哪里</h3> <p>https://docs.gitlab.com/ee/ci/caching/#where-the-caches-are-stored</p> <p>这里讲了如何使用cache，以及cache的最佳实践：</p> <ul><li>Tag your Runners and use the tag on jobs that share their cache.</li> <li>Use sticky Runners that will be only available to a particular project.</li> <li>Use a key that fits your workflow (for example, different caches on each branch). For that, you can take advantage of the CI/CD predefined variables.</li></ul> <h3 id="怎样清除cache"><a href="#怎样清除cache" aria-hidden="true" class="header-anchor">#</a> 怎样清除cache</h3> <p>注意cache是没有过期时间的，而且每一次新的push触发的pipeline，都会重新生成cache，重新生成的cache的名字为<code>&lt;cache-key&gt;-&lt;num&gt;</code>，其中num是随着push数量递增的。如果不去清除cache，cache会永久保留在Runner上，日积月累会填满存储空间的，因此最好隔一段时间进行一次清除，清除方法请参考https://docs.gitlab.com/ee/ci/caching/#clearing-the-cache，或者使用clear_volumes.sh 这个简单脚本来处理它, 清除cache的原理是将相关的volume移除，当然，docker也有自带的清除命令，推荐将docker system prune -f --volumes加入到定时任务中。</p> <h3 id="mac上的docker-volume在哪"><a href="#mac上的docker-volume在哪" aria-hidden="true" class="header-anchor">#</a> mac上的docker volume在哪</h3> <p>~/Library/Containers/com.docker.docker/Data/vms/0/</p> <p>使用screen 命令可以连接tty进入</p> <h3 id="gitlab-ci详解"><a href="#gitlab-ci详解" aria-hidden="true" class="header-anchor">#</a> Gitlab CI详解</h3> <ul><li>基本概念：https://docs.gitlab.com/ee/ci/introduction/</li> <li>CI配置详解：https://docs.gitlab.com/ee/ci/yaml/</li> <li>Gitlab容器注册：https://docs.gitlab.com/ee/user/packages/container_registry/index.html#enable-the-container-registry-for-your-project</li> <li>与Docker容器集成：https://docs.gitlab.com/ee/ci/docker/using_docker_build.html</li> <li>pipeline详解：https://docs.gitlab.com/ee/ci/pipelines/index.html</li> <li>gitlab runner配置详细说明:https://docs.gitlab.com/runner/configuration/</li></ul> <h3 id="maven的settings-xml"><a href="#maven的settings-xml" aria-hidden="true" class="header-anchor">#</a> maven的settings.xml</h3> <p>修改config.toml，加入volumes</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>volumes = [&quot;/Users/marszhang/.m2/settings.xml:/mvn/.m2/settings.xml&quot;,&quot;/var/run/docker.sock:/var/run/docker.sock&quot;,&quot;/cache&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改.gitlab-ci.yml，加入before_script段</p> <div class="language-yml line-numbers-mode"><pre class="language-text"><code>maven-build:
  image: maven:3-jdk-8
  stage: build
  before_script:
    - cp -f /mvn/.m2/settings.xml  $HOME/.m2/settings.xml
  script:
    - &quot;mvn package -B&quot;
  after_script:
    - rm -f $HOME/.m2/settings.xml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/spring/springbootRun.html" class="prev">
          Springboot启动过程
        </a></span> <span class="next"><a href="/spring/SpringBootTesting.html">
          SpringBoot 测试
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/4.80c27a58.js" defer></script><script src="/assets/js/app.ded2f491.js" defer></script>
  </body>
</html>
