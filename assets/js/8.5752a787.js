(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{175:function(s,t,a){s.exports=a.p+"assets/img/update3.f164d6de.jpg"},367:function(s,t,a){"use strict";a.r(t);var n=[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h2",{attrs:{id:"一起深度bug分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一起深度bug分析","aria-hidden":"true"}},[s._v("#")]),s._v(" 一起深度bug分析")]),s._v(" "),n("h3",{attrs:{id:"业务背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#业务背景","aria-hidden":"true"}},[s._v("#")]),s._v(" 业务背景")]),s._v(" "),n("pre",[n("code",[s._v("我们有一个业务是快速订单。快速订单提交审批后，会自动的生成发货单，然后自动占用库存，占用库存的时候订单微服务会调用库存微服务。\n这是一个较长的事务。业务上我们分成了2段本地事务。生成发货单是订单服务的本地事务，占用库存是库存服务的本地事务。发货单通过feign调用库存服务成功后，本地提交事务，写发货单占用记录。（这里面涉及到2阶段事务以及事务补偿，我们暂时放在一边）。\n")])]),s._v(" "),n("h3",{attrs:{id:"bug现象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#bug现象","aria-hidden":"true"}},[s._v("#")]),s._v(" bug现象")]),s._v(" "),n("pre",[n("code",[s._v("对于某批次商品，发现分别发货单占用记录的占用总数与库存账分配的占用数不一致。发货单占用总数大于库存账占用。\n")])]),s._v(" "),n("h3",{attrs:{id:"分析过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分析过程","aria-hidden":"true"}},[s._v("#")]),s._v(" 分析过程")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("1 首先我们怀疑事务出了问题，如果订单事务没有回滚，那么是可能出现占用多的情况。\n但是review代码以及检查日志，占用不成功的事务都成功的进行了回滚。")])]),s._v(" "),n("li",[n("p",[s._v("2 订单服务和库存服务的数据库事务都要写binlog,我们又从binlog入手分析。统计后发现，在该时间段内的单据，出现问题批次的商品，库存占用业务对数据库更新了99次，如果一致的话，那么发货单占用记录应该也是99条，但是发货单占用记录却为100条。又仔细看了库存占用binlog日志，库存服务的占用记录正常，没有突然不一致的情况，所以数据库执行上看起来没有问题。")])]),s._v(" "),n("li",[n("p",[s._v("3 问题已经大致定位到就是写入不一致导致的。继续review代码发现，订单业务先去查询库存，计算配货占用，写入占用记录表，然后feign调用库存业务申请占用，如果库存占用成功，则提交事务。那么为什么会出现写入不一致的情况呢？")])]),s._v(" "),n("li",[n("p",[s._v("4 继续分析binlog日志，发现某一个订单有10条占用明细，但是库存服务只有9条update的binlog，然而订单占用记录却有10条。又回头看代码，发现代码逻辑漏洞一个，因为是批量申请占用的，例如发给库存服务10个商品以及占用数量，库存服务对10个商品进行占用，执行update语句，如果10条update，有9条update，另外一条没有匹配到或者没有更新，只要不是占用不成功（申请占用数量大于可占用数量），库存服务不给出异常，那么订单服务也认为成功了。")])])]),s._v(" "),n("h3",{attrs:{id:"验证binlog"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证binlog","aria-hidden":"true"}},[s._v("#")]),s._v(" 验证binlog")]),s._v(" "),n("p",[n("code",[s._v("The binary log contains “events” that describe database changes such as table creation operations or changes to table data. It also contains events for statements that potentially could have made changes (for example, a DELETE which matched no rows), unless row-based logging is used. The binary log also contains information about how long each statement took that updated data.")])]),s._v(" "),n("h4",{attrs:{id:"实验1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实验1","aria-hidden":"true"}},[s._v("#")]),s._v(" 实验1")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("update")]),s._v(" film "),n("span",{attrs:{class:"token keyword"}},[s._v("set")]),s._v(" title"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token string"}},[s._v("'ACADEMY DINOSAUR'")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" film_id"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这条语句没有对数据库产生更改，因此也没有生成binlog")]),s._v(" "),n("h3",{attrs:{id:"实验2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实验2","aria-hidden":"true"}},[s._v("#")]),s._v(" 实验2")]),s._v(" "),n("p",[s._v("在这个实验中，我们批量更新3条记录。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("begin")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" film \n"),n("span",{attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" title "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("CASE")]),s._v("\n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACADEMY DINOSAUR_2'")]),s._v(" \n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACE GOLDFINGER_2'")]),s._v(" \n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACE GOLDFINGER_2'")]),s._v(" \n"),n("span",{attrs:{class:"token keyword"}},[s._v("END")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{attrs:{class:"token number"}},[s._v("2")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{attrs:{class:"token number"}},[s._v("3")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("commit")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("这条语句binlog日志为")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("BEGIN\n/*!*/;\n# at 122620053\n#201230  2:33:42 server id 1  end_log_pos 122620136 CRC32 0x0f2ed94d    Table_map: `freshalwms_test`.`film` mapped to number 316\n# at 122620136\n#201230  2:33:42 server id 1  end_log_pos 122620998 CRC32 0x5fa28f9c    Update_rows: table id 316 flags: STMT_END_F\n\n'/*!*/;\n### UPDATE `freshalwms_test`.`film`\n### WHERE\n###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACADEMY DINOSAUR' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266788 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### SET\n###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACADEMY DINOSAUR_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### UPDATE `freshalwms_test`.`film`\n### WHERE\n###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACE GOLDFINGER' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1139951022 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### SET\n###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### UPDATE `freshalwms_test`.`film`\n### WHERE\n###   @1=3 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ADAPTATION HOLES' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Reflection of a Lumberjack And a Car who must Sink a Lumberjack in A Baloon Factory' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=7 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=2.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=50 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=18.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=5 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1139951022 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### SET\n###   @1=3 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Reflection of a Lumberjack And a Car who must Sink a Lumberjack in A Baloon Factory' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=7 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=2.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=50 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=18.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=5 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n# at 122620998\n#201230  2:33:42 server id 1  end_log_pos 122621029 CRC32 0xa38697a9    Xid = 2069954\nCOMMIT/*!*/;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br")])]),n("h3",{attrs:{id:"实验3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实验3","aria-hidden":"true"}},[s._v("#")]),s._v(" 实验3")]),s._v(" "),n("p",[s._v("在这个实验中，我们批量更新3条记录，其中有2条可以更新，另外一条更新不到")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("begin")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" film \n"),n("span",{attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" title "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("CASE")]),s._v("\n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACADEMY DINOSAUR_2'")]),s._v(" \n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACE GOLDFINGER_2'")]),s._v(" \n "),n("span",{attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n "),n("span",{attrs:{class:"token string"}},[s._v("'ACE GOLDFINGER_2'")]),s._v(" \n"),n("span",{attrs:{class:"token keyword"}},[s._v("END")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" film_id "),n("span",{attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{attrs:{class:"token number"}},[s._v("2")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{attrs:{class:"token number"}},[s._v("3")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("commit")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[n("img",{attrs:{src:a(175),alt:"binlog"}})]),s._v(" "),n("p",[s._v("这条语句binlog日志为")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("BEGIN\n/*!*/;\n# at 140854194\n#201230 14:01:17 server id 1  end_log_pos 140854277 CRC32 0x38ebc8a3 \tTable_map: `freshalwms_test`.`film` mapped to number 316\n# at 140854277\n#201230 14:01:17 server id 1  end_log_pos 140854867 CRC32 0x94e3bc40 \tUpdate_rows: table id 316 flags: STMT_END_F\n### UPDATE `freshalwms_test`.`film`\n### WHERE\n###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACADEMY DINOSAUR_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### SET\n###   @1=1 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACADEMY DINOSAUR' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=6 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=0.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=86 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=20.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=2 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00001100' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609308077 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### UPDATE `freshalwms_test`.`film`\n### WHERE\n###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACE GOLDFINGER_2' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609266822 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n### SET\n###   @1=2 /* SHORTINT meta=0 nullable=0 is_null=0 */\n###   @2='ACE GOLDFINGER' /* VARSTRING(765) meta=765 nullable=0 is_null=0 */\n###   @3='A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China' /* BLOB/TEXT meta=2 nullable=1 is_null=0 */\n###   @4=2006 /* YEAR meta=0 nullable=1 is_null=0 */\n###   @5=1 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @6=NULL /* TINYINT meta=0 nullable=1 is_null=1 */\n###   @7=3 /* TINYINT meta=0 nullable=0 is_null=0 */\n###   @8=4.99 /* DECIMAL(4,2) meta=1026 nullable=0 is_null=0 */\n###   @9=48 /* SHORTINT meta=0 nullable=1 is_null=0 */\n###   @10=12.99 /* DECIMAL(5,2) meta=1282 nullable=0 is_null=0 */\n###   @11=1 /* ENUM(1 byte) meta=63233 nullable=1 is_null=0 */\n###   @12=b'00000101' /* SET(1 bytes) meta=63489 nullable=1 is_null=0 */\n###   @13=1609308077 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n# at 140854867\n#201230 14:01:17 server id 1  end_log_pos 140854898 CRC32 0xde887e33 \tXid = 2377876\nCOMMIT/*!*/;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br")])]),n("p",[s._v("可以看到只有两个update语句，而第三个没有update。")]),s._v(" "),n("p",[s._v("这证实了我们的怀疑。")]),s._v(" "),n("p",[s._v("继续review代码。iwm有2个服务实例，用了redis key作为lock锁。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("  "),n("span",{attrs:{class:"token annotation punctuation"}},[s._v("@Transactional")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rollbackFor "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" Exception"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token keyword"}},[s._v("class")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("addSummaryAllocQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("InvSummaryAllocQtyDTO summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token comment"}},[s._v("//库存锁")]),s._v("\n        String redisLockKey "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" RedisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("IWM_LOCK"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("replace")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("RedisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("APP_INFO_PLACEHOLDER0"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getWarehouseID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('":"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v("summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getCustomerID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockService"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("lock")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            ImInvSummary imInvSummary "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" imInvSummaryMapper"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("selectByPrimaryKey")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getInvSummaryID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("imInvSummary "),n("span",{attrs:{class:"token operator"}},[s._v("==")]),s._v(" null"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常, 库存明细-[{}] 查询为空"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getInvSummaryID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("SystemException")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BaseErrorCodes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("NOTNULL"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token string"}},[s._v('"库存明细-["')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getInvSummaryID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('"]"')]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),n("span",{attrs:{class:"token comment"}},[s._v("//判断调整单调整前数量是否与库存数量一致 todo")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("//                if (summaryAllocQtyDTO.getDocType().equals(DocType.ADJUST.getValue())) {")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("//                    if (imInvSummary.getBalanceQty().compareTo(summaryAllocQtyDTO.getBeforeQty()) != 0) {")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v('//                        logger.error("调整单过账异常, SKU-[{}] 过账前数量[{}] 与 库存余额[{}] 不一致", imInvSummary.getSkuID(), summaryAllocQtyDTO.getBeforeQty(), imInvSummary.getBalanceQty());')]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v('//                        throw new SystemException(OrderErrorCodes.QTY_ERROR, new Object[]{"sku-" + imInvSummary.getSkuID() + "-调整前"});')]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("//                    }")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("//                }")]),s._v("\n                "),n("span",{attrs:{class:"token comment"}},[s._v("//调整后数量")]),s._v("\n                BigDecimal afterAllocQty "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getAllocQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("add")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("afterAllocQty"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("compareTo")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getBalanceQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("0")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    Sku sku "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("this")]),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("searchSKUByID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getSkuID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    String skuName "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" StringUtils"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("isNotBlank")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sku"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getCommonName")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("?")]),s._v(" sku"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getCommonName")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" sku"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getSkuStdName")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常, SKU-[{}]-[{}] 库存明细 -[{}] 调整后占用数量[{}] 大于库存余额数量[{}]"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getSkuID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skuName"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getId")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" afterAllocQty"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getBalanceQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("SystemException")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OrderErrorCodes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("QTY_ERROR"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常, SKU-"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" sku"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getSkuCode")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('"-"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" skuName "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('"批次："')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getLotNo")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('",调整后占用数量:"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" afterAllocQty "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('" ,大于库存余额数量:"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getBalanceQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("setAllocQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("afterAllocQty"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("preUpdate")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" imInvSummaryMapper"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("updateByPrimaryKeySelective")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("imInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常："')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getMessage")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                redisLockService"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("unlock")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常, 未获取到redislock : {} 或调整明细-{}处于锁定状态"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" summaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getInvSummaryID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v('//            throw new RuntimeException("未获取到redislock : " + redisLockKey);')]),s._v("\n            "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("SystemException")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OrderErrorCodes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OPERATION_FAILED"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token string"}},[s._v('"需要调整明细处于锁定状态,稍后重试"')]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[s._v("/**\n    * 批量增加占用\n    *\n    * @author tongt.gao\n    * @param\n    * @createDate 2020/12/22 14:59\n    **/")]),s._v("\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[s._v("@Transactional")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rollbackFor "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" Exception"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token keyword"}},[s._v("class")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("addBatchSummaryAllocQty")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("List"),n("span",{attrs:{class:"token generics function"}},[n("span",{attrs:{class:"token punctuation"}},[s._v("<")]),s._v("InvSummaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" dtoList"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token comment"}},[s._v("//根据仓库及货主信息分组")]),s._v("\n        Map"),n("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v("String"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" List"),n("span",{attrs:{class:"token generics function"}},[n("span",{attrs:{class:"token punctuation"}},[s._v("<")]),s._v("InvSummaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" customerMap "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" dtoList"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("stream")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("collect")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Collectors"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("groupingBy")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),n("span",{attrs:{class:"token operator"}},[s._v("-")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" a"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getWarehouseID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),n("span",{attrs:{class:"token string"}},[s._v('":"')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" a"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getCustomerID")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{attrs:{class:"token comment"}},[s._v("//循环处理每个货主的占用")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Map"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Entry"),n("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v("String"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" List"),n("span",{attrs:{class:"token generics function"}},[n("span",{attrs:{class:"token punctuation"}},[s._v("<")]),s._v("InvSummaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" detail "),n("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" customerMap"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("entrySet")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{attrs:{class:"token keyword"}},[s._v("long")]),s._v(" begin "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" System"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("currentTimeMillis")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token comment"}},[s._v("//redis锁key值")]),s._v("\n            logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("info")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"批量增加占用开始获取 RedisLockKey：warehouseID:customerID:{}"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" detail"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getKey")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            String redisLockKey "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" RedisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("IWM_LOCK"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("replace")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("RedisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("APP_INFO_PLACEHOLDER0"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" detail"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getKey")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockService"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("lock")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("info")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"批量增加占用RedisLockKey获取成功，RedisLockKey: {}，耗时：{} ms"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" System"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("currentTimeMillis")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v(" begin"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    List"),n("span",{attrs:{class:"token generics function"}},[n("span",{attrs:{class:"token punctuation"}},[s._v("<")]),s._v("ImInvSummary"),n("span",{attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" summaryList "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("ArrayList")]),n("span",{attrs:{class:"token operator"}},[s._v("<")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("InvSummaryAllocQtyDTO invSummaryAllocQtyDTO "),n("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" detail"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getValue")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        summaryList"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("add")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token keyword"}},[s._v("this")]),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("checkSummary")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("invSummaryAllocQtyDTO"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),n("span",{attrs:{class:"token comment"}},[s._v("//批量更新库存明细")]),s._v("\n                    imInvSummaryMapper"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("updateQtyBatch")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("summaryList"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常："')]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("getMessage")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" e"),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    redisLockService"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("unlock")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("info")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"批量增加占用结束，RedisLockKey释放成功，RedisLockKey: {}，耗时：{}"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" System"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("currentTimeMillis")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v(" begin"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                logger"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{attrs:{class:"token function"}},[s._v("error")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token string"}},[s._v('"占用数量调整异常, redislock : {} 未获取到或处于锁定状态"')]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" redisLockKey"),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("SystemException")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OrderErrorCodes"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OPERATION_FAILED"),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{attrs:{class:"token string"}},[s._v('"需要调整明细处于锁定状态,稍后重试"')]),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br")])]),n("p",[s._v("由于数据库事务隔离级别为READ COMMITED,在并发高的情况下，会有概率出现")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("步骤")]),s._v(" "),n("th",[s._v("iwm1")]),s._v(" "),n("th",[s._v("iwm2")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("1")]),s._v(" "),n("td",[s._v("开始数据库事务")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("2")]),s._v(" "),n("td"),s._v(" "),n("td",[s._v("开始数据库事务")])]),s._v(" "),n("tr",[n("td",[s._v("3")]),s._v(" "),n("td",[s._v("准备获得redis lock")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("4")]),s._v(" "),n("td"),s._v(" "),n("td",[s._v("准备获得redis lock")])]),s._v(" "),n("tr",[n("td",[s._v("5")]),s._v(" "),n("td",[s._v("获得redis lock成功")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("6")]),s._v(" "),n("td"),s._v(" "),n("td",[s._v("等待redis lock")])]),s._v(" "),n("tr",[n("td",[s._v("7")]),s._v(" "),n("td",[s._v("执行数据库事务")]),s._v(" "),n("td",[s._v("等待redis lock")])]),s._v(" "),n("tr",[n("td",[s._v("8")]),s._v(" "),n("td",[s._v("释放锁")]),s._v(" "),n("td",[s._v("等待redis lock")])]),s._v(" "),n("tr",[n("td",[s._v("9")]),s._v(" "),n("td",[s._v("释放成功")]),s._v(" "),n("td",[s._v("等待redis lock")])]),s._v(" "),n("tr",[n("td",[s._v("10")]),s._v(" "),n("td"),s._v(" "),n("td",[s._v("获得redis lock锁成功")])]),s._v(" "),n("tr",[n("td",[s._v("11")]),s._v(" "),n("td"),s._v(" "),n("td",[s._v("查询summary占用余额")])]),s._v(" "),n("tr",[n("td",[s._v("12")]),s._v(" "),n("td",[s._v("提交数据库事务")]),s._v(" "),n("td")])])]),s._v(" "),n("p",[s._v("上表，如果iwm1在还没有提交数据库事务的情况下，iwm2获得的占用余额就是未更新的，这样就出现了脏读，导致iwm可能也去更新同样数量的占用")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("select")]),s._v(" alloc "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" summary "),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// alloc = 100")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 100-1 =99")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("update")]),s._v(" summary "),n("span",{attrs:{class:"token keyword"}},[s._v("set")]),s._v(" alloc"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token number"}},[s._v("99")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("对于iwm2可能也是要去占用1个")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[s._v("select")]),s._v(" alloc "),n("span",{attrs:{class:"token keyword"}},[s._v("from")]),s._v(" summary "),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// alloc = 100")]),s._v("\n"),n("span",{attrs:{class:"token comment"}},[s._v("// 100-1 =99")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("update")]),s._v(" summary "),n("span",{attrs:{class:"token keyword"}},[s._v("set")]),s._v(" alloc"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token number"}},[s._v("99")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("这个时候iwm2，因为alloc已经是99个了，就不会执行update")])])}],e=a(0),l=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);l.options.__file="lock.md";t.default=l.exports}}]);